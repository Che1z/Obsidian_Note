# NetListener.cs 與混雜模式 (Promiscuous Mode)

您的理解完全正確。如果不是在 Promiscuous（混雜）模式下，Probe 的網卡幾乎無法得知其他設備之間的通訊，這會讓 Probe 變得毫無用處。

讓我為您深入解釋「為什麼」，以及這與 [[ARP and GARP|ARP/GARP]] 的關係。

## 1. 網路卡的「正常模式」 vs 「混雜模式」

### 正常模式 (Normal Mode)

在預設的正常模式下，網路介面卡 (NIC) 的硬體晶片會執行一個非常重要的基本任務：**過濾**。

當一個乙太網路封包 (Ethernet Frame) 抵達網卡時，網卡會檢查封包標頭中的目的 [[MAC 位址]] (Destination [[MAC 位址]])。

它只會接受並往上層（作業系統）傳遞滿足以下三種條件之一的封包：
1.  目的 MAC 位址完全符合這張網卡自己的 MAC 位址。
2.  目的 [[MAC 位址]] 是 [[廣播 (Broadcast)]]位址 (FF:FF:FF:FF:FF:FF)。
3.  目的 MAC 位址是該網卡有加入的多播 (Multicast) 群組位址。

所有不符合以上條件的封包，都會在硬體層級被直接丟棄，作業系統和上層的應用程式（如 [[SharpPcap]]）根本不會知道這些封包的存在。

**打個比方：** 您的網卡就像一個只會收取寫有自己名字的信件的信箱。它會收下「給所有住戶的傳單」（廣播），但會直接扔掉所有寄給鄰居的信（單播 Unicast）。

### 混雜模式 (Promiscuous Mode)

當 `NetListener.cs` 透過 `nic.Open(DeviceModes.Promiscuous, ...)` 啟用混雜模式時，它等於是告訴網卡：

> 「請關閉你的硬體過濾功能。不要管目的 MAC 位址是什麼，只要是你看得到的封包，無論是寄給誰的，全部都收下來交給作業系統。」

**打個比方：**
啟用混雜模式的網卡就像是一個社區的警衛室，它會把所有進出這個社區的信件都複製一份來進行安全檢查，無論收件人是誰。

## 2. 這對 Probe 和 ARP/GARP 意味著什麼？

現在我們來看看 Probe 的工作場景：

一個網路交換器 (Switch) 上連接了多台電腦（Host A, Host B）和一台 PIXIS Probe。

### 場景一：Host A 要與 Host B 通訊

1.  Host A 可能會先發送一個 [[ARP and GARP|ARP Request]]（[[廣播 (Broadcast)|廣播]]）：「請問 [[IP 位址]] 為 192.168.1.10 的是誰？請告訴我你的 [[MAC 位址]]。」
2.  因為是廣播，所以交換器會把這個封包轉發給所有連接埠，Probe 在正常模式下也能收到。
3.  Host B 收到後，會回覆一個 [[ARP and GARP|ARP Reply]]（單播 Unicast）：「我是 192.168.1.10，我的 [[MAC 位址]] 是 BB:BB:BB:BB:BB:BB。」 這個封包的目的 [[MAC 位址]] 是 Host A 的 [[MAC 位址]]。
4.  智慧交換器會直接將這個封包只轉發到連接 Host A 的埠口。
5.  **關鍵來了：** 如果 Probe 的網卡是正常模式，當這個 ARP Reply 封包流經它所在的埠口時，網卡會檢查到目的 MAC 是 Host A 的，不是自己的，也不是廣播，於是直接在硬體層將其丟棄。Probe 的程式 (`NetListener.cs`) 將永遠無法得知 Host B 的存在和它的 MAC 位址。
6.  只有在混雜模式下，Probe 的網卡才會無視目的 MAC，將這個 ARP Reply 封包收下，`NetListener.cs` 才能分析它，從而得知「喔，網路上有一台 Host B，它的 IP 和 MAC 是...」。

### 場景二：一台新設備發出 GARP (Gratuitous ARP)

*   GARP 通常是用來宣告自己的 IP 位址，或是在 IP 變更後通知網路上所有設備更新快取。它通常是一個廣播封包。
*   雖然廣播封包在正常模式下也能收到，但 Probe 的核心任務是全面監控，它不能只依賴廣播。網路中絕大多數的流量（網頁瀏覽、檔案傳輸等）都是單播的。

## 結論

PIXIS.Probe 的核心價值在於成為網路上的一個「觀察者」或「監聽者」，它需要知道網段上所有設備的身份、行為以及它們之間的互動，才能執行網路存取控制 (NAC) 的策略。

如果沒有啟用混雜模式，Probe 就會變成一個「瞎子」，它只能看到直接發給它自己的、或是全網廣播的封包，而會錯過 99% 的其他設備之間的單播流量。這就使得它無法建立完整的網路設備畫像，也無法判斷是否有未經授權的通訊行為，其核心功能便無從談起。

因此，Promiscuous Mode 對於 `NetListener.cs` 來說，不是一個選項，而是**必要條件**。
